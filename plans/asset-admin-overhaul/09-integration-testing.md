# Stage 09: Integration Testing

## Objective

End-to-end testing of all three user workflow stages, performance verification, and deployment validation.

## Dependencies

- **Requires:** All previous stages (01-08) complete

## Complexity

**Low** - Testing and verification, no new code.

---

## Files to Create

| File | Purpose |
|------|---------|
| `tests/asset-admin-e2e.md` | Manual test checklist (if no automated tests) |

---

## Test Scenarios

### Stage 1: Reference Generation

#### Test 1.1: Generate Reference with Custom Prompt
**Steps:**
1. Navigate to `/admin/assets`
2. Click "Generate" button
3. Select category: `building_ref`
4. Select asset type: `restaurant`
5. Proceed to Prompt step
6. Verify template loads automatically
7. Edit the prompt (change some text)
8. Click "Save as Template"
9. Verify success toast
10. Continue through wizard
11. Click Generate

**Expected:**
- Template loaded from database
- Save operation succeeds
- Generation starts
- Asset appears in list with "generating" status
- Eventually moves to "review" status

#### Test 1.2: Generate Reference with Reference Images
**Steps:**
1. Start Generate wizard
2. Select category: `building_ref`
3. Go to References step
4. Upload a new reference image
5. Verify it appears in library
6. Select it and one approved asset
7. Complete generation

**Expected:**
- Upload succeeds
- Both references appear as selected
- Generation includes both references (check logs)
- asset_reference_links records created

#### Test 1.3: Generate with Custom Settings
**Steps:**
1. Start Generate wizard
2. Go to Settings step
3. Set temperature to 1.5
4. Set topK to 60
5. Complete generation

**Expected:**
- Settings stored in `generation_settings` JSON
- Gemini called with custom settings (check logs)

### Stage 2: Reference Approval â†’ Auto-Create Sprites

#### Test 2.1: Approve Building Reference
**Steps:**
1. Find a `building_ref` asset in "review" status
2. Open preview
3. Click "Approve"

**Expected:**
- Asset status changes to "approved"
- Response includes `autoGeneratedSprites` array
- New `building_sprite` asset created with status "pending"
- Sprite has `parent_asset_id` set to reference ID
- Sprite has `auto_created = TRUE`
- Sprite appears in Building Sprites tab

#### Test 2.2: Verify Auto-Created Sprite
**Steps:**
1. After approving reference, navigate to Building Sprites tab
2. Find the auto-created sprite
3. Open preview

**Expected:**
- "Auto-created" badge visible
- Parent reference link shown
- Reference image automatically included

#### Test 2.3: Re-approve Doesn't Duplicate
**Steps:**
1. Approve an already-approved reference (if UI allows)
2. Or via API: `PUT /api/admin/assets/approve/:id`

**Expected:**
- No duplicate sprites created
- Response indicates no new sprites (or returns existing)

### Stage 3: Sprite Approval Flow

#### Test 3.1: Regenerate Creates New Version
**Steps:**
1. Find a sprite in "review" status
2. Open preview
3. Click "Regenerate"
4. In RegenerateModal, modify prompt slightly
5. Click Regenerate

**Expected:**
- New asset created with variant + 1
- Old asset status = "completed" (preserved)
- Both versions visible in list
- New version inherits parent_asset_id and references

#### Test 3.2: Approve Triggers Background Removal
**Steps:**
1. Find a `building_sprite` in "review" status
2. Approve it

**Expected:**
- Status changes to "approved"
- Background removal triggered (Slazzer API called)
- `background_removed` flag set to TRUE
- Cloudflare resize + WebP conversion happens
- `r2_key_public` populated
- `r2_url` populated with public URL

#### Test 3.3: Regenerate with New References
**Steps:**
1. Open RegenerateModal
2. Go to References tab
3. Remove existing references
4. Add different references
5. Regenerate

**Expected:**
- New version has new reference links
- Old references not copied

#### Test 3.4: Regenerate with New Settings
**Steps:**
1. Open RegenerateModal
2. Go to Settings tab
3. Set temperature to 0.3 (Precise)
4. Regenerate

**Expected:**
- New version has updated settings
- Other settings inherited from original

---

## API Verification Tests

### Reference Library API
```bash
# List images
curl -H "Authorization: Bearer <token>" \
  "https://boss.notropolis.net/api/admin/assets/reference-library"

# Upload image
curl -X POST \
  -H "Authorization: Bearer <token>" \
  -F "file=@test.png" \
  -F "name=Test Reference" \
  -F "category=buildings" \
  "https://boss.notropolis.net/api/admin/assets/reference-library/upload"

# Get preview
curl -H "Authorization: Bearer <token>" \
  "https://boss.notropolis.net/api/admin/assets/reference-library/1/preview"
```

### Prompt Templates API
```bash
# Get template
curl -H "Authorization: Bearer <token>" \
  "https://boss.notropolis.net/api/admin/assets/prompts/building_ref/restaurant"

# Update template
curl -X PUT \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"basePrompt": "Updated prompt...", "changeNotes": "Test update"}' \
  "https://boss.notropolis.net/api/admin/assets/prompts/building_ref/restaurant"

# Get history
curl -H "Authorization: Bearer <token>" \
  "https://boss.notropolis.net/api/admin/assets/prompts/building_ref/restaurant/history"
```

### Generate API
```bash
# Generate with all params
curl -X POST \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "category": "building_ref",
    "asset_key": "test_building",
    "prompt": "Custom test prompt...",
    "reference_images": [{"type": "library", "id": 1}],
    "generation_settings": {"temperature": 0.5}
  }' \
  "https://boss.notropolis.net/api/admin/assets/generate"
```

### Regenerate API
```bash
# Regenerate with overrides
curl -X POST \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "Modified prompt...",
    "generation_settings": {"temperature": 1.2}
  }' \
  "https://boss.notropolis.net/api/admin/assets/regenerate/123"
```

---

## Database Verification

### After Reference Library Upload
```sql
SELECT * FROM reference_images ORDER BY id DESC LIMIT 5;
-- Verify: r2_key, thumbnail_r2_key, dimensions, uploaded_by
```

### After Template Update
```sql
SELECT * FROM prompt_templates
WHERE category = 'building_ref' AND asset_key = 'restaurant'
ORDER BY version DESC;
-- Verify: multiple versions, is_active flags
```

### After Generation
```sql
SELECT
    ga.id, ga.category, ga.asset_key, ga.status,
    ga.generation_settings, ga.parent_asset_id, ga.auto_created,
    (SELECT COUNT(*) FROM asset_reference_links WHERE asset_id = ga.id) as ref_count
FROM generated_assets ga
ORDER BY ga.id DESC LIMIT 5;
```

### After Auto-Sprite Creation
```sql
SELECT
    ga.id, ga.category, ga.asset_key, ga.variant,
    ga.parent_asset_id, ga.auto_created, ga.auto_created_from,
    parent.asset_key as parent_asset_key
FROM generated_assets ga
LEFT JOIN generated_assets parent ON ga.parent_asset_id = parent.id
WHERE ga.auto_created = TRUE
ORDER BY ga.id DESC LIMIT 5;
```

---

## Performance Tests

### Generation Queue Throughput
```bash
# Queue multiple generations
for i in {1..10}; do
  curl -X POST \
    -H "Authorization: Bearer <token>" \
    -H "Content-Type: application/json" \
    -d "{\"category\": \"building_ref\", \"asset_key\": \"test_$i\"}" \
    "https://boss.notropolis.net/api/admin/assets/generate"
done

# Monitor queue
watch -n 5 'curl -s -H "Authorization: Bearer <token>" \
  "https://boss.notropolis.net/api/admin/assets/queue" | jq'
```

### Reference Library Load
```bash
# Time listing with many images
time curl -s -H "Authorization: Bearer <token>" \
  "https://boss.notropolis.net/api/admin/assets/reference-library" | jq '.count'

# Should complete in < 2 seconds for 100+ images
```

### Prompt Template Load
```bash
# Time template loading
time curl -s -H "Authorization: Bearer <token>" \
  "https://boss.notropolis.net/api/admin/assets/prompts/building_ref/restaurant"

# Should complete in < 500ms
```

---

## Error Handling Tests

### Invalid Reference Image
```bash
# Try to use non-existent reference
curl -X POST \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "category": "building_ref",
    "asset_key": "test",
    "reference_images": [{"type": "library", "id": 99999}]
  }' \
  "https://boss.notropolis.net/api/admin/assets/generate"

# Expected: Warning logged, generation proceeds without missing ref
```

### Invalid Settings
```bash
# Try extreme settings
curl -X POST \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "category": "building_ref",
    "asset_key": "test",
    "generation_settings": {"temperature": 100, "topK": -5}
  }' \
  "https://boss.notropolis.net/api/admin/assets/generate"

# Expected: Settings clamped to valid ranges
```

### Gemini API Failure
```bash
# Temporarily invalid API key to test error handling
# Check that:
# - Asset status = 'failed'
# - error_message populated
# - Queue status = 'failed'
```

---

## Acceptance Checklist

### Stage 1: Reference Generation
- [ ] Generate wizard opens with 5 steps
- [ ] Template loads from database
- [ ] Prompt is editable and saveable
- [ ] Reference library shows uploaded images
- [ ] Can upload new reference images
- [ ] Can select approved assets as references
- [ ] Settings sliders work
- [ ] Presets apply correct values
- [ ] Generation starts successfully
- [ ] Generation settings stored in database
- [ ] Reference links created in database

### Stage 2: Auto-Create Sprites
- [ ] Approving building_ref creates building_sprite
- [ ] Sprite has correct parent_asset_id
- [ ] Sprite has auto_created flags set
- [ ] Sprite appears in correct category
- [ ] Reference link auto-created
- [ ] Sprite queued for generation
- [ ] No duplicate sprites on re-approve

### Stage 3: Sprite Approval
- [ ] Regenerate creates new version
- [ ] Old version preserved as 'completed'
- [ ] Can override prompt in regenerate
- [ ] Can change references in regenerate
- [ ] Can change settings in regenerate
- [ ] Approve triggers background removal
- [ ] Approve triggers WebP conversion
- [ ] Public URL generated

### General
- [ ] All audit logs created correctly
- [ ] Error handling works gracefully
- [ ] Performance acceptable (<2s for lists)
- [ ] No console errors in browser
- [ ] No unhandled exceptions in worker logs

---

## Deployment Verification

### Pre-Deployment
```bash
# Verify migrations applied
npx wrangler d1 execute notropolis-db --command "SELECT name FROM sqlite_master WHERE type='table';"
# Should include: reference_images, asset_reference_links, prompt_templates

# Verify columns added
npx wrangler d1 execute notropolis-db --command "PRAGMA table_info(generated_assets);"
# Should include: generation_settings, auto_created, auto_created_from
```

### Post-Deployment
```bash
# Quick smoke test
curl -H "Authorization: Bearer <token>" \
  "https://boss.notropolis.net/api/admin/assets/reference-library"
# Should return 200

curl -H "Authorization: Bearer <token>" \
  "https://boss.notropolis.net/api/admin/assets/prompts"
# Should return categories list

# UI smoke test
# 1. Open https://boss.notropolis.net/admin/assets
# 2. Click Generate
# 3. Verify wizard appears
```

---

## Rollback Plan

If issues are detected:

### Worker Rollback
```bash
# Rollback to previous worker version
npx wrangler rollback
```

### Database Rollback (if needed)
```sql
-- Drop new tables (DESTRUCTIVE - only if no data)
DROP TABLE IF EXISTS asset_reference_links;
DROP TABLE IF EXISTS reference_images;
DROP TABLE IF EXISTS prompt_templates;

-- Remove new columns (D1 doesn't support DROP COLUMN easily)
-- May need to recreate table without new columns
```

### Frontend Rollback
- Revert to previous GenerateModal.tsx
- Revert to previous AssetPreviewModal.tsx
- Redeploy

---

## Sign-Off

| Reviewer | Date | Status |
|----------|------|--------|
| Developer | | |
| QA | | |
| Product | | |
