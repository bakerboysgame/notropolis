# Multi-Tenant SaaS Authentication API Template
# Cloudflare Worker Configuration
#
# SETUP INSTRUCTIONS:
# 1. Replace account_id with your Cloudflare account ID
# 2. Create a D1 database: wrangler d1 create your-app-database
# 3. Update database_id with the ID from step 2
# 4. Create a KV namespace: wrangler kv:namespace create RATE_LIMIT_KV
# 5. Update the KV namespace id and preview_id
# 6. Update CLIENT_URL and SERVER_URL with your domains
# 7. Set secrets in Cloudflare dashboard:
#    - wrangler secret put JWT_SECRET
#    - wrangler secret put POSTMARK_SERVER_TOKEN

name = "notropolis-api"
compatibility_date = "2024-09-23"
account_id = "329dc0e016dd5cd512d6566d64d8aa0c"
main = "index.js"

# ==================== D1 DATABASE ====================
# Create: wrangler d1 create notropolis-database
[[d1_databases]]
binding = "DB"
database_name = "notropolis-database"
database_id = "9bbea853-8bb6-4e13-8713-e8086fef0528"

# ==================== KV NAMESPACE (Rate Limiting) ====================
# Create: wrangler kv:namespace create RATE_LIMIT_KV
# Create preview: wrangler kv:namespace create RATE_LIMIT_KV --preview
[[kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "b0bff4ae1eaa4acba02039fb14fb280b"
preview_id = "e05954baf2de423bb0d94a404832e0f5"

# ==================== R2 STORAGE (Optional) ====================
# Uncomment if you need file storage
# Create: wrangler r2 bucket create notropolis-data
# [[r2_buckets]]
# binding = "DATA_BUCKET"
# bucket_name = "notropolis-data"

# ==================== ENVIRONMENT VARIABLES ====================
[vars]
# Non-sensitive configuration (public)
# Sensitive variables must be set as secrets in Cloudflare dashboard

# Basic configuration - 30 day sessions for game users
JWT_EXPIRES_IN = "30d"
SESSION_TIMEOUT = "2592000000"
BRAND_NAME = "Notropolis"
CLIENT_URL = "https://boss.notropolis.net"
SERVER_URL = "https://api.notropolis.net"
CORS_ORIGIN = "https://boss.notropolis.net"

# Email sender configuration
SENDER_NAME = "Notropolis"
SENDER_EMAIL = "no-reply@notropolis.net"
SUPPORT_EMAIL = "support@notropolis.net"

# Security Rate Limiting Configuration
RATE_LIMIT_LOGIN = "20"           # Max login attempts per window
RATE_LIMIT_LOGIN_WINDOW = "900"   # Window in seconds (15 min)
RATE_LIMIT_API = "100"            # Max API requests per window
RATE_LIMIT_API_WINDOW = "60"      # Window in seconds (1 min)
SESSION_IDLE_TIMEOUT = "2592000000"  # Idle timeout in ms (30 days to match JWT)

# ==================== PRODUCTION ENVIRONMENT ====================
[env.production]
name = "notropolis-api"

[env.production.vars]
ENVIRONMENT = "production"
JWT_EXPIRES_IN = "30d"
SESSION_TIMEOUT = "2592000000"
BRAND_NAME = "Notropolis"
CLIENT_URL = "https://boss.notropolis.net"
SERVER_URL = "https://api.notropolis.net"
CORS_ORIGIN = "https://boss.notropolis.net"
SENDER_NAME = "Notropolis"
SENDER_EMAIL = "no-reply@notropolis.net"
SUPPORT_EMAIL = "support@notropolis.net"
RATE_LIMIT_LOGIN = "20"
RATE_LIMIT_LOGIN_WINDOW = "900"
RATE_LIMIT_API = "100"
RATE_LIMIT_API_WINDOW = "60"
SESSION_IDLE_TIMEOUT = "2592000000"

# D1 Database for production
[[env.production.d1_databases]]
binding = "DB"
database_name = "notropolis-database"
database_id = "9bbea853-8bb6-4e13-8713-e8086fef0528"

# KV Namespace for production
[[env.production.kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "b0bff4ae1eaa4acba02039fb14fb280b"

# ==================== PREVIEW ENVIRONMENT ====================
[env.preview]
name = "notropolis-api-preview"

[env.preview.vars]
ENVIRONMENT = "preview"

# D1 Database for preview (can use same as production or separate)
[[env.preview.d1_databases]]
binding = "DB"
database_name = "notropolis-database"
database_id = "9bbea853-8bb6-4e13-8713-e8086fef0528"

# KV Namespace for preview
[[env.preview.kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "e05954baf2de423bb0d94a404832e0f5"

# ==================== CRON TRIGGERS ====================
# Game tick system - runs every 10 minutes
[triggers]
crons = ["*/10 * * * *"]
